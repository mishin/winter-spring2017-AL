<!DOCTYPE html>
<html lang="en" ng-app="StudentApp">

<head>
    <title>SLOChart | Student</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, shrink-to-fit=no, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="studentPage.css">
    <!-- Angular CSS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.4/angular.min.js"></script>
    <script src="ui-bootstrap-tpls-0.1.0.js"></script>
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- JQuery CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body ng-controller="StudentCtrl">
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <h3>Course Catalog</h3>
            <br>
            <form>
                <span>Name:  </span>
                <input type="text" ng-model="searchInput.name"/><br>
                <span>Title:   </span>
                <input type="text" ng-model="searchInput.title"/><br>
            </form>
            <br>
            <div>
                <ul id="catalog1" class="catalogTable">
                    <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in catalogCourses | orderBy:['name'] | filter:searchInput">
                        <span>{{c.name}}</span>
                        <br>
                        {{c.title}}
                    </li>
                </ul>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->
        <div id="header">
            <a href="#menu-toggle" class="header-item-left" id="menu-toggle">Catalog</a>
            <a href="#menu-toggle" class="header-item-left" id="courses-toggle">Required Courses</a>
            <div class="dropdown">
                <p class="header-item-left">Saved Flowcharts</p>
                <div class="dropdown-content">
                    <a href="#" data-flowchartId="{{f.id}}" ng-repeat="f in userFlowcharts" ng-click="loadPlannedCourses(f.id)">{{f.flowchartName}}</a>
                    <a href="#" style="text-align:center;font-weight:bold;">+</a>
                </div>
            </div>
            <a class="header-item-left" ng-click="savePlannedCourses()">Save</a>
            <div class="dropdown">
                <p class="header-item-left">Options</p>
                <div class="dropdown-content">
                    <a href="#">Change Major</a>
                    <a href="#">Add/Change Minor</a>
                    <a href="#">Add/Change Concentration</a>
                    <a href="#">Visual Settings</a>
                </div>
            </div>
            <span style="float:right"><p class="header-item-right">Logout {{userEmail}}</p></span>
        </div>
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div>
                        <h2>Editing "{{selectedFlowchartName}}"
                            <img src="http://simpleicon.com/wp-content/uploads/pencil.png" ng-click="editFlowchartName()" style="position:relative;width:32px;height:32px;">
                        </h2>
                        <br>

                        <div class="flowchart">
                            <div class="year">
                                <h1>Freshman</h1>
                                <div class="flowchartQuarterColumn">
                                    <h1>Fall</h1>
                                    <ul id="quarter1" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 1 && c.quarter == 1">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Winter</h1>
                                    <ul id="quarter2" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 1 && c.quarter == 2">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Spring</h1>
                                    <ul id="quarter3" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 1 && c.quarter == 3">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="year">
                                <h1>Sophomore</h1>
                                <div class="flowchartQuarterColumn">
                                    <h1>Fall</h1>
                                    <ul id="quarter4" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 2 && c.quarter == 1">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Winter</h1>
                                    <ul id="quarter5" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 2 && c.quarter == 2">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Spring</h1>
                                    <ul id="quarter6" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 2 && c.quarter == 3">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="year">
                                <h1>Junior</h1>
                                <div class="flowchartQuarterColumn">
                                    <h1>Fall</h1>
                                    <ul id="quarter7" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 3 && c.quarter == 1">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Winter</h1>
                                    <ul id="quarter8" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 3 && c.quarter == 2">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Spring</h1>
                                    <ul id="quarter9" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 3 && c.quarter == 3">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="year">
                                <h1>Senior</h1>
                                <div class="flowchartQuarterColumn">
                                    <h1>Fall</h1>
                                    <ul id="quarter10" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 4 && c.quarter == 1">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Winter</h1>
                                    <ul id="quarter11" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 4 && c.quarter == 2">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                                <div class="flowchartQuarterColumn">
                                    <h1>Spring</h1>
                                    <ul id="quarter12" class="flowchartQuarter">
                                        <li class="course {{c.educationArea}}" data-courseId="{{c.courseId}}" ng-repeat="c in plannedCourses | orderBy:'position'" ng-if="c.year == 4 && c.quarter == 3">
                                            <span class="courseDeleteButton" onclick="$(this).parent().remove();">X</span>
                                            <span>{{c.name}}</span>
                                            <br>
                                            {{c.title}}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--<a href="#menu-toggle" class="btn btn-default" id="menu-toggle">Toggle Menu</a>-->
                    <br>
                    <h4>FAQs</h4>
                    <div class="faq_container">
                        <div class="faq">
                            <div class="faq_question"> &#x25BE; How do I add a minor? </div>
                            <div class="faq_answer_container">
                                <div class="faq_answer">
                                    First, click the Options button, then select "Add Minor". Choose the minor that
                                    you'd like to add, and the Required Courses section will populate with the required
                                    courses.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="faq_container">
                        <div class="faq">
                            <div class="faq_question"> &#x25BE; How do I edit a flowchart? </div>
                            <div class="faq_answer_container">
                                <div class="faq_answer">
                                    To edit a flowchart, click Saved Flowcharts, then select the flowchart you wish to
                                    edit. Drag and drop the classes you wish to move to their new locations.  Click the
                                    save button and your changes will be persisted. If you would like to print your
                                    flowchart, click Export.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="faq_container">
                        <div class="faq">
                            <div class="faq_question"> &#x25BE; How do I display the flowchart information? </div>
                            <div class="faq_answer_container">
                                <div class="faq_answer">
                                    Open the Catalog menu, then select the flowchart you wish to view information for.
                                    A popup window will display with the flowchart name, flowchart description, prerequisites,
                                    and term the flowchart is typically offered.  Once finished, click anywhere outside of
                                    the box and the popup box will disappear.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="faq_container">
                        <div class="faq">
                            <div class="faq_question"> &#x25BE; How do I make a note? </div>
                            <div class="faq_answer_container">
                                <div class="faq_answer">
                                    Click on the class you would like to make a note on. Within the popup box, click on add note.
                                    Write what you need in the note. Click the Add Note button and your editing session will end
                                    Your new note will be displayed whenever you click on that class. The flowchart will have a visual cue showing that the note has been added.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="faq_container">
                        <div class="faq">
                            <div class="faq_question"> &#x25BE; If I have changed my major, how do I change my flowchart to represent my new major? </div>
                            <div class="faq_answer_container">
                                <div class="faq_answer">
                                    First, select the “Edit Profile” option in the sidebar of your home screen. In the editing page, change your major selection to represent your new major and save your profile.
                                    Select the option “Add New Flowchart”. You will know have a flowchart populated with courses related to your new major.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="faq_container">
                        <div class="faq">
                            <div class="faq_question"> &#x25BE; How do I mark a flowchart as complete? </div>
                            <div class="faq_answer_container">
                                <div class="faq_answer">
                                    Click the edit button on the sidebar to enter editing mode for the flowchart. Select the flowchart you would like to mark in your flowchart.
                                    A box with options should appear on selection. Choose to mark the flowchart as complete.  Click the save button and your editing session will end.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /#page-content-wrapper -->
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <!-- Menu Toggle Script -->
    <script>
        $("#menu-toggle").click(function(e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
        });
    </script>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>

    <script>
        $(document).ready(function() {
            $('.faq_question').click(function() {
                if ($(this).parent().is('.open')){
                    $(this).closest('.faq').find('.faq_answer_container').animate({'height':'0'},500);
                    $(this).closest('.faq').removeClass('open');
                    } else{
                        var newHeight =$(this).closest('.faq').find('.faq_answer').height() +'px';
                        $(this).closest('.faq').find('.faq_answer_container').animate({'height':newHeight},500);
                        $(this).closest('.faq').addClass('open');
                    }
            });
        });
    </script>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        var app = angular.module('StudentApp', ['ui.bootstrap']);

        function createNewFlowchart($scope, $http, name){
            console.log($scope.plannedCourses);
            $http({
                method : 'POST',
                url : 'studentFlowchart',
                data : {
                    "studentId": $scope.userId,
                    "flowchartName": name,
                    "plannedCourses": $scope.plannedCourses
                }
            }).then(function (response) {
                $scope.userFlowcharts.push(response.data);
                $scope.selectedFlowchartId = response.data.id;
                $scope.selectedFlowchartName = response.data.flowchartName;
                $scope.savePlannedCourses();
            });
        };

        function createDefaultFlowchart($scope, $http){
            $http.get("/majorFlowchart/major/" + $scope.userMajor)
            .then(function (response) {
                loadPlannedCoursesFromCatalog($scope, $http, response.data.defaultFlowchart.plannedCourses);
                createNewFlowchart($scope, $http, "Default Flowchart");
            });
        };

        function loadUserInformation($scope, $http){
            console.log(window.sessionStorage.getItem("token"));
            var token = window.sessionStorage.getItem("token");

            $http({
                method : 'GET',
                url : 'user',
                headers : {
                    "X-Auth-Token" : token
                }
            }).then(function (response) {
                console.log("user id:");
                console.log(response.data.id);
                $scope.userId = response.data.id;
                $scope.userEmail = response.data.email;
                $scope.userMajor = response.data.major;

                $http.get("/studentFlowchart/student/" + $scope.userId)
                .then(function (response) {
                    $scope.userFlowcharts = response.data;

                    console.log($scope.userFlowcharts);
                    console.log($scope.userFlowcharts.length);

                    if ($scope.userFlowcharts.length == 0) {
                        $scope.userFlowcharts = [];
                        console.log($scope.userFlowcharts);
                        createDefaultFlowchart($scope, $http);
                    };

                    $scope.loadPlannedCourses($scope.selectedFlowchartId);
                });

                console.log(response);
            });
        }

        function loadPlannedCoursesFromCatalog($scope, $http, data) {
            $http({
                method : 'GET',
                url : 'catalog'
            }).then(function (response) {
                $scope.plannedCourses = [];
                $('.flowchartQuarter li').remove();

                angular.forEach(data, function(plannedCourse) {
                    angular.forEach(response.data, function(catalogCourse) {
                        if(catalogCourse.courseId == plannedCourse.courseId) {
                            catalogCourse.year = plannedCourse.year;
                            catalogCourse.quarter = plannedCourse.quarter;
                            catalogCourse.position = plannedCourse.position;

                            $scope.plannedCourses.push(catalogCourse);
                        }
                    });
                });

                $scope.savePlannedCourses();
            });
        }

        function setHeaderFunctions ($scope, $http) {
            $scope.loadPlannedCourses = function loadPlannedCourses(flowchartId){
                $scope.plannedCourses = [];
                $http.get("/studentFlowchart/" + flowchartId)
                .then(function (response) {
                    $scope.selectedFlowchartId = response.data.id;
                    $scope.selectedFlowchartName = response.data.flowchartName;
                    loadPlannedCoursesFromCatalog($scope, $http, response.data.plannedCourses);
                });
            }

            $scope.savePlannedCourses = function() {
                $scope.savedCourses = [];

                var quarters = document.getElementsByClassName("flowchartQuarter");
                var q = 0;
                angular.forEach(quarters, function(quarter) {
                    var courses = quarter.getElementsByClassName("course");
                    p = 1;
                    angular.forEach(courses, function(course) {
                        $scope.savedCourses.push( {
                            "courseId": course.dataset.courseid,
                            "year": Math.floor(q/3) + 1,
                            "quarter": (q%3) + 1,
                            "position": p
                        } );
                        p = p + 1;
                    });
                    q = q + 1;
                });

                console.log("saved courses: ");
                console.log($scope.savedCourses);
                $http({
                    method : 'PUT',
                    url : 'studentFlowchart/' + $scope.selectedFlowchartId,
                    data : $scope.savedCourses
                }).then(function (response) {
                    console.log("check response to see if the backend says its all cool");
                    console.log("then give user either error or confirmation");
                    console.log(response.status);
                    if (response.status < 300) {
                        console.log("SUCCESSFUL SAVE");
                    }
                    else {
                        console.log("FAILURE TO SAVE");
                    }
                });
                console.log($scope.savedCourses);
            };

            $scope.editFlowchartName = function() {
                var oldName = $scope.selectedFlowchart;
                var newName = window.prompt("Enter new flowchart name.", $scope.selectedFlowchartName);

                if (newName == null || newName == "") {
                    console.log("cancelled prompt");
                } else {
                    $http({
                    method : 'PUT',
                    url : 'studentFlowchart/' + $scope.selectedFlowchartId + '/name',
                    data : newName
                    }).then(function (response) {
                        if (response.status < 300) {
                            $scope.selectedFlowchartName = newName;
                            console.log($scope.userId);
                            $http.get("/studentFlowchart/student/" + $scope.userId)
                            .then(function (response) {
                                $scope.userFlowcharts = response.data;
                            });
                            console.log($scope.userId);
                        }
                        else {
                            window.alert("There was a problem renaming your flowchart.");
                        }
                    });
                }
            };
        }

        function loadCatalogCourses ($scope, $http){
            $http({
                method : 'GET',
                url : 'catalog'
            }).then(function (response) {
                $scope.catalogCourses = response.data;
            });
        }

        app.controller('StudentCtrl', function ($scope, $http) {
            loadUserInformation($scope, $http);
            setHeaderFunctions($scope, $http);
            loadCatalogCourses($scope, $http);
        });

    </script>
    <script>
        setTimeout(function() {
            $( "#quarter1, #quarter2, #quarter3, #quarter4, #quarter5, #quarter6, #quarter7, #quarter8, #quarter9, #quarter10, #quarter11, #quarter12" ).sortable({
                    connectWith: ".flowchartQuarter",
                    placeholder: "coursePlaceholder",
                    update: function(event, ui) {
                        console.log("TODO put flowchart validation here");
                    },
                    stop: function(event, ui) {
                        if ($(ui.item).find(".courseDeleteButton").length == 0)
                        {
                            var courseDeleteButton = $("<span class='courseDeleteButton'>X</span>").click(function(){
                                $(this).parent().remove();
                            });
                            $(ui.item).prepend(courseDeleteButton);
                        }
                    }
                }).disableSelection();

                $( "#catalog1 .course" ).draggable({
                    connectToSortable: ".flowchartQuarter",
                    helper: "clone",
                    revert: "invalid",
                    cursorAt: { top: 50, left: 50 }
                 });
            }, 15000);
    </script>
</body>
</html>