<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

<div class="container mb-5">
  <!-- Content here -->
  <div class="row">
    <table id="postTable" class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Post</th>
        </tr>
      </thead>
      <tbody>
        <!-- Empty Table to Hold Data-->
      </tbody>
    </table>
  </div>
  <button id="getPosts" class="btn btn-primary mt-1">Load Posts</button>
</div>


<div class="container mt-3">
<form>
  <div class="form-group row">
    <label for="title-input" class="col-2 col-form-label">Title</label>
    <div class="col-3">
      <input class="form-control" type="text" id="title-input">
    </div>
  </div>
  <div class="form-group row">
    <label for="post-input" class="col-2 col-form-label">Post</label>
    <div class="col-6">
      <input class="form-control" type="text" id="post-input">
    </div>
  </div>
  <div class="row justify-content-md-left offset-2 mt-3">
      <button id="deletePost" class="btn btn-danger ">Delete</button>
      <button id="updatePost"  class="btn btn-success mr-2 ml-2">Update</button>
      <button id="createPost"  class="btn btn-warning">Create</button>
  </div>
</form>
</div>

<div class="container mt-5">
<form>
  <div class="form-group row">
    <label for="server-input" class="col-2 col-form-label">API Endpoint</label>
    <div class="col-8">
      <input class="form-control" type="text" id="server-input">
    </div>
    <button id="setServer" class="btn">Set</button>
  </div>
</form>
</div>

<script>

$(function() {

  let postStore = {};

  var SERVER_ROOT = "https://cp-avengers.herokuapp.com/";
  //var SERVER_ROOT = "http://localhost:8080/";
  var POST_RESOURCE = "post";
  var POST_API_ENDPOINT = SERVER_ROOT + POST_RESOURCE;

  const table = $("#postTable tbody");
  const titleInput = $("#title-input");
  const postInput = $("#post-input");

  const serverInput = $("#server-input");

  addClickHandlers();
  setTableClickHandler();
  updateServerUrl();

  function updateServerUrl() {
    serverInput.val(POST_API_ENDPOINT);
  }

  function clearTable(){
    table.empty();
  }

  function loadPostsIntoTable(posts) {
    if (Array.isArray(posts)){
      postStore = {};
      for (let post of posts) {
          postStore[post.id] = post;
          var row = "<tr class=\"post-row\" data-id="+post.id+"><td>"+post.id+"</td><td>"+post.title+"</td><td>"+post.post+"</td</tr>";
          table.append(row);
      }
    }

    setTableClickHandler();
  }

  function setTableClickHandler() {
    $(".post-row").click(function() {
        var id = $(this).data("id");
        $(this).addClass('table-active').siblings().removeClass('table-active');
        loadPostIntoForm(id);
    });
  }

  function loadPostIntoForm(id){
    var post = postStore[id];

    if (post) {
      titleInput.val(post.title);
      postInput.val(post.post);
    }
  }

  function clearPostForm(){
     titleInput.empty();
     postInput.empty();
  }

  function clearActiveRow(){
    $(".table-active").removeClass("table-active");
  }

  function fetchPosts() {
    $.ajax({
      method: "GET",
      url: POST_API_ENDPOINT
      })
      .done(function( data ) {
        clearTable();
        loadPostsIntoTable(data);
        clearActiveRow();
        clearPostForm();
    });
  }

  function getPostFormData() {
    return { title: titleInput.val(),
             post: postInput.val()}
  }

  function addClickHandlers(){

    $("#getPosts").click(function(e){
        e.preventDefault();

        fetchPosts();
    });

    $("#updatePost").click(function(e){
      e.preventDefault();

      var id = $(".table-active").data("id");
      var data = getPostFormData();
      console.log(data);

      $.ajax({
        method: "PUT",
        url: POST_API_ENDPOINT + "/" + id,
        data: JSON.stringify(data),
        contentType: "application/json",
        dataType: "json"
      })
      .done(function (data) {
        console.log(data);
        fetchPosts();
      })
      .fail(function (msg) {
        console.log(msg);
      });
    });

    $("#deletePost").click(function(e){
      e.preventDefault();

      var id = $(".table-active").data("id");

      $.ajax({
        method: "DELETE",
        url: POST_API_ENDPOINT + "/" + id
      })
      .done(function (data) {
        console.log(data);

        fetchPosts();
      })
      .fail(function (msg) {
        console.log(msg);
      });
    });

    $("#createPost").click(function(e){
      e.preventDefault();

      var data = getPostFormData();
      console.log(data);

      $.ajax({
        method: "POST",
        url: POST_API_ENDPOINT,
        data: JSON.stringify(data),
        contentType: "application/json",
        dataType: "json"
      })
      .done(function (data) {
        console.log(data);
        fetchPosts();
      })
      .fail(function (msg) {
        console.log(msg);
      });
    });

    //ServerURL input
    $("#setServer").click(function(e){
      e.preventDefault();

      POST_API_ENDPOINT = serverInput.val();
      updateServerUrl();
    })
  }

});
</script>
